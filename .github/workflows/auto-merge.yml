name: Auto-merge Jules PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  resolve-progress-conflicts:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'google-labs-jules' ||
      github.event.pull_request.user.login == 'google-labs-jules[bot]'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:base-branch
      
      - name: Try merge and resolve PROGRESS.md conflicts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Attempt merge with union strategy (this should handle PROGRESS.md automatically via .gitattributes)
          if ! git merge base-branch -X union --no-edit; then
            # If merge failed, check if PROGRESS.md has conflicts
            if git diff --name-only --diff-filter=U | grep -q "docs/PROGRESS.md"; then
              echo "Resolving PROGRESS.md conflicts by combining both versions..."
              
              # Get both versions (ours is HEAD/PR branch, theirs is base-branch)
              git show HEAD:docs/PROGRESS.md > progress-ours.md 2>/dev/null || echo "" > progress-ours.md
              git show base-branch:docs/PROGRESS.md > progress-theirs.md 2>/dev/null || echo "" > progress-theirs.md
              
              # Union merge: combine both versions, keeping all content from both
              # Remove the header from one if both have it, then concatenate
              {
                # Keep header from ours, then append theirs (skipping its header if present)
                head -n 1 progress-ours.md
                echo ""
                tail -n +2 progress-ours.md
                echo ""
                echo "---"
                echo ""
                tail -n +2 progress-theirs.md
              } > docs/PROGRESS.md
              
              git add docs/PROGRESS.md
              git commit -m "Resolve PROGRESS.md conflicts: union merge (accept both versions)" || true
            fi
          else
            echo "Merge succeeded without conflicts"
          fi
      
      - name: Push resolved conflicts
        run: |
          git push origin HEAD:${{ github.event.pull_request.head.ref }} || echo "Nothing to push or push failed"
  
  enable-auto-merge:
    runs-on: ubuntu-latest
    needs: resolve-progress-conflicts
    if: |
      github.event.pull_request.user.login == 'google-labs-jules' ||
      github.event.pull_request.user.login == 'google-labs-jules[bot]'
    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr ready "$PR_URL" || true
          gh pr merge --auto --squash "$PR_URL"
