<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animation Helpers</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #111;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <script type="module">
    import { Helios, interpolate, spring, sequence, series } from '../../packages/core/dist/index.js';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const resizeCanvas = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    };
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const helios = new Helios({ duration: 5, fps: 30 });
    helios.bindToDocumentTimeline();

    // Define sequence steps
    const steps = [
      { name: 'Phase 1: Grow', durationInFrames: 30, color: 'crimson' },
      { name: 'Phase 2: Hold', durationInFrames: 60, color: 'teal' },
      { name: 'Phase 3: Shrink', durationInFrames: 30, color: 'gold' }
    ];

    // Calculate start times automatically
    // series() adds a 'from' property to each item
    // We start the sequence at frame 60 (after the initial movement settles a bit)
    const timeline = series(steps, 60);

    function draw(frame) {
      const { width, height } = canvas;

      // Clear canvas
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, width, height);

      // --- SECTION 1: Interpolate & Spring ---

      // Interpolate X position: 0 -> 500 (or width/2) over frames 0 -> 60
      // We'll move from left edge to center
      const x = interpolate(frame, [0, 60], [100, width / 2], { extrapolateRight: 'clamp' });

      // Spring scale: pop in from 0 to 1 starting at frame 0
      const scale = spring({
          frame: frame,
          fps: 30,
          from: 0,
          to: 1,
          config: { stiffness: 120, damping: 10 }
      });

      // Draw Rectangle at X
      ctx.fillStyle = 'royalblue';
      // Shift up by 100px to make room for sequence below
      ctx.fillRect(x - 50, (height / 2) - 150, 100, 100);

      // Draw Circle with Scale, positioned to the right of the rectangle
      const circleX = width / 2 + 200;
      const circleY = (height / 2) - 100;

      ctx.save();
      ctx.translate(circleX, circleY);
      ctx.scale(scale, scale);
      ctx.beginPath();
      ctx.arc(0, 0, 50, 0, Math.PI * 2);
      ctx.fillStyle = 'tomato';
      ctx.fill();
      ctx.restore();

      // --- SECTION 2: Sequence & Series ---

      // Draw Sequence Demo at the bottom
      const seqStartY = (height / 2) + 50;

      ctx.font = '20px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillStyle = '#fff';
      ctx.fillText("Sequence & Series Demo (Starts at f:60)", 50, seqStartY - 20);

      timeline.forEach((step, index) => {
        const seq = sequence({
          frame,
          from: step.from,
          durationInFrames: step.durationInFrames
        });

        // Calculate position
        const boxX = 50 + (index * 160);
        const boxY = seqStartY;
        const boxW = 150;
        const boxH = 50;

        // Draw background slot
        ctx.fillStyle = '#333';
        ctx.fillRect(boxX, boxY, boxW, boxH);

        if (seq.isActive) {
           // Highlight active step
           ctx.fillStyle = step.color;
           // Fill based on progress (left to right)
           ctx.fillRect(boxX, boxY, boxW * seq.progress, boxH);

           // Text Active
           ctx.fillStyle = '#fff';
           ctx.textAlign = 'center';
           ctx.fillText(step.name, boxX + boxW/2, boxY + 32);
        } else {
           // Text Inactive
           ctx.fillStyle = '#666';
           ctx.textAlign = 'center';
           ctx.fillText(step.name, boxX + boxW/2, boxY + 32);
        }

        // Draw frame info below box
        ctx.fillStyle = '#888';
        ctx.font = '12px monospace';
        ctx.fillText(`[${step.from}-${step.from + step.durationInFrames}]`, boxX + boxW/2, boxY + boxH + 15);
        ctx.font = '20px sans-serif'; // Reset font
      });

      // --- Debug Info ---
      ctx.font = '20px sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.fillText(`Frame: ${frame.toFixed(0)}`, width/2, 50);
      ctx.fillText(`Interpolate: ${x.toFixed(0)} | Spring: ${scale.toFixed(2)}`, width/2, 80);
    }

    helios.subscribe(state => draw(state.currentFrame));

    // Initial draw
    draw(0);

    window.helios = helios;
  </script>
</body>
</html>
