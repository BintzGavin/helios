<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Composition</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #eee;
      }
      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="960" height="540"></canvas>

    <script type="module">
      // Import the framework-provided animation helpers
      import { initializeAnimation } from "../../packages/core/dist/index.js";

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // Animation state
      let animationProgress = 0;

      // Function to render the current frame
      function render() {
        // Clear canvas
        ctx.fillStyle = "#eee";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Calculate box properties based on animation progress
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const boxSize = 150;

        // Animation: fade in, scale up, then move to the left
        const opacity = Math.min(animationProgress * 2, 1);
        const scale = 0.5 + animationProgress * 0.5;
        const moveX = animationProgress * (canvas.width - boxSize);

        // Draw the animated box
        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.translate(centerX - moveX, centerY);
        ctx.scale(scale, scale);

        ctx.fillStyle = "#007bff";
        ctx.fillRect(-boxSize / 2, -boxSize / 2, boxSize, boxSize);

        ctx.restore();
      }

      // Create custom animation controller for canvas
      function createCanvasAnimationController() {
        // Function to update animation progress directly
        function updateAnimationProgress(progress) {
          animationProgress = progress;
          render();
        }

        // Function to set animation timing
        function setAnimationTiming(startTime, endTime, totalDuration) {
          // Store timing info for future use
          window.animationTiming = { startTime, endTime, totalDuration };
        }

        // Function to update animation based on current time
        function updateAnimationAtTime(currentTime, totalDuration) {
          const timing = window.animationTiming || {
            startTime: 0,
            endTime: 5,
            totalDuration: 5,
          };

          // Calculate animation progress based on timing
          let progress = 0;
          if (
            currentTime >= timing.startTime &&
            currentTime <= timing.endTime
          ) {
            // Animation is active
            progress =
              (currentTime - timing.startTime) /
              (timing.endTime - timing.startTime);
          } else if (currentTime > timing.endTime) {
            // Animation has finished
            progress = 1;
          }
          // If currentTime < startTime, progress remains 0

          updateAnimationProgress(progress);
        }

        // Attach functions to window for the player to use
        window.updateAnimationProgress = updateAnimationProgress;
        window.setAnimationTiming = setAnimationTiming;
        window.updateAnimationAtTime = updateAnimationAtTime;

        return {
          updateAnimationProgress,
          setAnimationTiming,
          updateAnimationAtTime,
        };
      }

      // Initialize the canvas animation system
      createCanvasAnimationController();

      // Initial render
      render();
    </script>
  </body>
</html>
