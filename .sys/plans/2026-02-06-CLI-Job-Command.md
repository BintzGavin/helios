# CLI: Distributed Job Execution Command

## 1. Context & Goal
- **Objective**: Implement the `helios job run` command to execute distributed rendering job specifications generated by `helios render --emit-job`.
- **Trigger**: The current CLI supports generating distributed job plans (JSON) via `--emit-job`, but lacks a built-in command to execute them. This forces users to write custom scripts to parse and run the jobs, creating friction for local verification and simple distributed workflows.
- **Impact**: This command closes the loop on distributed rendering by providing a standard "Runner" implementation. It enables local verification of distributed workflows, supports "stateless worker" patterns (by running single chunks), and serves as a reference for future cloud execution adapters.

## 2. File Inventory
- **Create**:
  - `packages/cli/src/commands/job.ts`: Implementation of the `helios job` command and its `run` subcommand.
  - `packages/cli/src/types/job.ts`: Type definitions for `JobSpec` and related interfaces (shared with `render.ts`).
  - `tests/e2e/verify-cli-job.ts`: A new E2E test script to verify the job generation and execution workflow.
- **Modify**:
  - `packages/cli/src/index.ts`: Register the new `job` command.
  - `packages/cli/src/commands/render.ts`: Update to use the shared `JobSpec` type for type safety when generating the JSON.
- **Read-Only**:
  - `packages/renderer/src/Orchestrator.ts`: Reference for consistency (do not modify).

## 3. Implementation Spec

### Architecture
- **Command**: `helios job run <file> [options]`
- **Options**:
  - `--chunk <id>`: Execute only the chunk with the specified ID. (Enables stateless worker mode).
  - `--concurrency <number>`: Number of concurrent chunks to run locally. Defaults to `1`.
  - `--no-merge`: Skip the final merge step. Useful when running single chunks or if the merge is handled separately.

### Shared Types (`packages/cli/src/types/job.ts`)
Define the contract for the Job Spec JSON.
```typescript
export interface RenderJobChunk {
  id: number;
  startFrame: number;
  frameCount: number;
  outputFile: string;
  command: string;
}

export interface RenderJobMetadata {
  totalFrames: number;
  fps: number;
  width: number;
  height: number;
  duration: number;
}

export interface JobSpec {
  metadata: RenderJobMetadata;
  chunks: RenderJobChunk[];
  mergeCommand: string;
}
```

### Logic Flow (`packages/cli/src/commands/job.ts`)
1. **Load Job Spec**: Read the JSON file from the provided path. Validate basic structure.
2. **Determine Work**:
   - If `--chunk <id>` is provided: Select only that chunk.
   - If no chunk ID: Select all chunks.
3. **Execute Chunks**:
   - Iterate over selected chunks.
   - For each chunk:
     - Spawn the `chunk.command` using `child_process.spawn`.
     - Use `{ stdio: 'inherit', shell: true }` to preserve output and environment.
     - Handle concurrency if multiple chunks are selected (use a standard promise pool or `p-limit` if available, otherwise simple chunking).
   - If any chunk fails, abort and exit with error.
4. **Execute Merge**:
   - Condition: If `!options.chunk` and `!options.noMerge`.
   - Execute `jobSpec.mergeCommand`.

### Public API Changes
- New CLI command `helios job`.
- New shared type `JobSpec`.

## 4. Test Plan
- **Verification Script**: Create `tests/e2e/verify-cli-job.ts`.
  - **Step 1**: Build the `packages/cli` package (and dependencies).
  - **Step 2**: Select a simple example (e.g., `examples/simple-canvas-animation`).
  - **Step 3**: Run `helios render <example> --emit-job job.json`.
  - **Step 4**: Verify `job.json` exists and matches `JobSpec` structure.
  - **Step 5**: Run `helios job run job.json`.
  - **Step 6**: Verify the final output video exists and has valid size/duration.
  - **Step 7 (Chunk Mode)**: Run `helios job run job.json --chunk 0 --no-merge`.
  - **Step 8**: Verify the chunk output file (e.g., `...part_0.mov`) exists.

- **Success Criteria**:
  - The `helios job run` command successfully orchestrates the execution of the commands in the JSON file.
  - The output video is identical (or functionally equivalent) to a direct `helios render`.
