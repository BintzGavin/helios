# Renderer Context

## A. Strategy: Dual-Path Architecture
The Renderer uses the Strategy pattern to support two distinct rendering modes:
1.  **Canvas Strategy**:
    *   Optimized for `<canvas>`-based animations (WebGL, Three.js, PixiJS).
    *   Uses **WebCodecs API** (`VideoEncoder`) to capture frames directly from the canvas context.
    *   **Data Transfer Optimization**: Uses `Blob` and `FileReader` for efficient zero-copy-like transfer of encoded chunks from browser to Node.js.
    *   Encoding happens in-browser, and encoded chunks are piped to FFmpeg.
    *   **Smart Codec Selection**: Automatically prioritizes `avc1` (H.264 Annex B) when `videoCodec: 'copy'` is requested to enable direct stream copy, falling back to `vp8` (IVF) if unsupported.
    *   Supports `avc1` (H.264), `vp9`, and `av01` (AV1) intermediate codecs.
    *   Uses `CdpTimeDriver` (Chrome DevTools Protocol) for precise, deterministic time control.

2.  **DOM Strategy**:
    *   Optimized for HTML/CSS animations.
    *   Uses `SeekTimeDriver` (WAAPI) to advance time.
    *   Captures frames using `page.screenshot()` (currently, pending `Element.capture` or similar).
    *   **Transparent Video Export**: Supports transparency (alpha channel) by detecting `yuva` or `rgba` pixel formats and configuring Playwright to `omitBackground`.
    *   Injects polyfills via `SeekTimeDriver.init()` to ensure `requestAnimationFrame`, `Date.now`, and `performance.now` are deterministic from frame 0.
    *   **Deep DOM Discovery**: Automatically detects `<audio>` and `<video>` elements, and preloads fonts/images across **all frames** (including iframes), aggregating audio tracks for the final render.
    *   **Media Attributes**: Respects `data-helios-offset`, `data-helios-seek`, and `muted` attributes on media elements for precise timing and volume control.
    *   **Media Synchronization**: Manually syncs `<video>` and `<audio>` elements to the virtual timeline in SeekTimeDriver, respecting offset and seek attributes.
    *   **Frame Synchronization**: `SeekTimeDriver` iterates over all attached frames (including iframes) to inject polyfills and synchronize virtual time, ensuring complex compositions render correctly.
    *   **Stability Wait**: Waits for `document.fonts.ready` and media element `seeked` events (with timeout) after every seek to ensure deterministic frame capture without artifacts.

## B. File Tree
```
packages/renderer/src/
├── drivers/
│   ├── CdpTimeDriver.ts       # CDP-based time control
│   ├── SeekTimeDriver.ts      # WAAPI-based time control with polyfills
│   └── TimeDriver.ts          # Interface for time drivers
├── strategies/
│   ├── CanvasStrategy.ts      # WebCodecs capture implementation
│   ├── DomStrategy.ts         # DOM/Screenshot capture implementation
│   └── RenderStrategy.ts      # Interface for strategies
├── utils/
│   ├── FFmpegBuilder.ts       # Centralized FFmpeg argument generation
│   ├── FFmpegInspector.ts     # FFmpeg capabilities probe
│   └── concat.ts              # Video concatenation utility
├── index.ts                   # Main entry point (Renderer class)
└── types.ts                   # Type definitions (RendererOptions, etc.)
```

## C. Configuration: RendererOptions
The `RendererOptions` interface controls the rendering process:
- `width`, `height`, `fps`, `durationInSeconds`: Basic video properties.
- `mode`: `'canvas'` or `'dom'`.
- `videoCodec`: Output codec (e.g., `'libx264'`, `'libvpx-vp9'`).
- `pixelFormat`: Output pixel format (e.g., `'yuv420p'`, `'yuva420p'`).
- `intermediateVideoCodec`: Codec for WebCodecs capture (e.g., `'avc1'`, `'vp9'`, `'av01'`).
- `intermediateImageFormat`: Capture format for DOM mode (`'png'` or `'jpeg'`).
- `intermediateImageQuality`: Quality (0-100) for JPEG capture.
- `videoBitrate`: Target bitrate (e.g., `2500000`).
- `audioCodec`: Output audio codec (e.g., `'aac'`, `'libvorbis'`).
- `audioBitrate`: Output audio bitrate (e.g., `'192k'`).
- `audioFilePath`: Path to background audio file.
- `audioTracks`: Array of audio tracks for mixing.
- `subtitles`: Path to SRT file for caption burning (requires transcoding).
- `inputProps`: Object injected into the page as `window.__HELIOS_PROPS__`.
- `ffmpegPath`: Custom path to FFmpeg binary.
- `startFrame`: Frame index to start rendering from.

## D. FFmpeg Interface
The Renderer spawns FFmpeg with arguments generated by `FFmpegBuilder`. Common flags include:
- Inputs:
    - `-f ivf` or `-f h264` (for WebCodecs input stream)
    - `-f image2pipe` (for DOM screenshot stream)
    - `-i pipe:0` (read from stdin)
    - `-i <audio_file>` (for audio tracks)
- Filters:
    - `-vf` / `-filter_complex`: Used for scaling, pixel format conversion, audio mixing (`amix`, `adelay`, `volume`), and **subtitle burning** (`subtitles`).
- Output:
    - `-c:v <videoCodec>` (e.g., `libx264` or `copy`)
    - `-pix_fmt <pixelFormat>` (omitted if `videoCodec` is `copy`)
    - `-movflags +faststart` (for MP4)
    - `-y` (overwrite output)

## E. Diagnostics
The `renderer.diagnose()` method performs a comprehensive environment check:
- **Browser**: Checks for `VideoEncoder` support, WAAPI availability, and `OffscreenCanvas`.
- **FFmpeg**: Uses `FFmpegInspector` to verify the binary version and list supported encoders/filters (e.g., verifying `libx264` presence).
